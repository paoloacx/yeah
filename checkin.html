<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <title>Nuevo Check-in - Yeah!</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-btn">← Volver</a>
            <h1>Nuevo Check-in</h1>
        </header>

        <main class="checkin-form">
            <div id="locationStatus" class="status-message">
                Obteniendo ubicación...
            </div>

            <div id="mapPreview"></div>

            <div class="form-section">
                <label>Ubicación</label>
                <div id="currentLocation" class="location-display">
                    Cargando...
                </div>
            </div>

            <div class="form-section">
                <label for="placeSearch">Buscar lugar (opcional)</label>
                <input type="text" id="placeSearch" placeholder="Buscar tienda, restaurante...">
                <div id="placeResults" class="place-results"></div>
                <p class="hint">Deja vacío para guardar solo coordenadas GPS</p>
            </div>

            <div class="form-section">
                <label for="placeNote">Nota (opcional)</label>
                <textarea id="placeNote" rows="3" placeholder="¿Qué hiciste aquí?"></textarea>
            </div>

            <div class="form-section">
                <label for="placePhoto">Foto (opcional)</label>
                <input type="file" id="placePhoto" accept="image/*" capture="environment">
                <div id="photoPreview"></div>
            </div>

            <button id="saveCheckin" class="btn-primary">Guardar Check-in</button>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/maps.js"></script>
    <script>
        let currentPosition = null;
        let selectedPlace = null;
        let compressedPhoto = null;
        let map = null;

        // Inicializar mapa
        function initMap(lat, lng) {
            if (map) return;
            
            map = L.map('mapPreview').setView([lat, lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            L.marker([lat, lng]).addTo(map);
        }

        // Obtener ubicación
        document.addEventListener('DOMContentLoaded', () => {
            const status = document.getElementById('locationStatus');
            const locationDisplay = document.getElementById('currentLocation');

            if (!navigator.geolocation) {
                status.textContent = 'Geolocalización no disponible';
                status.classList.add('error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };

                    status.textContent = 'Ubicación obtenida ✓';
                    status.classList.add('success');
                    locationDisplay.textContent = `${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`;
                    
                    initMap(currentPosition.lat, currentPosition.lng);
                    searchNearbyPlaces(currentPosition.lat, currentPosition.lng);
                },
                (error) => {
                    status.textContent = 'Error obteniendo ubicación';
                    status.classList.add('error');
                    console.error(error);
                }
            );
        });

        // Buscar lugares cercanos (placeholder para Google Places API)
        function searchNearbyPlaces(lat, lng) {
            const resultsDiv = document.getElementById('placeResults');
            resultsDiv.innerHTML = '<p class="hint">API de Google Places no configurada. Puedes guardar solo las coordenadas GPS.</p>';
            
            // TODO: Implementar cuando se tenga API key de Google Places
            // const apiKey = 'TU_API_KEY';
            // fetch(`https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lng}&radius=100&key=${apiKey}`)
        }

        // Búsqueda manual de lugares
        document.getElementById('placeSearch').addEventListener('input', (e) => {
            const query = e.target.value;
            if (query.length < 3) return;
            
            // TODO: Implementar búsqueda con Google Places API cuando esté disponible
            document.getElementById('placeResults').innerHTML = '<p class="hint">Búsqueda disponible cuando se configure Google Places API</p>';
        });

        // Manejo de foto
        document.getElementById('placePhoto').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Redimensionar si es muy grande
                    const maxSize = 800;
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height *= maxSize / width;
                            width = maxSize;
                        } else {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    compressedPhoto = canvas.toDataURL('image/jpeg', 0.8);
                    
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = `<img src="${compressedPhoto}" alt="Preview" style="max-width: 100%; border-radius: 8px;">`;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Guardar check-in
        document.getElementById('saveCheckin').addEventListener('click', () => {
            if (!currentPosition) {
                alert('Esperando ubicación...');
                return;
            }

            const checkin = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                location: currentPosition,
                place: selectedPlace,
                note: document.getElementById('placeNote').value.trim(),
                photo: compressedPhoto
            };

            Storage.saveCheckin(checkin);
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
