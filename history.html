<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <title>Historial - Yeah!</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-btn">‚Üê Volver</a>
            <h1>Historial</h1>
        </header>

        <main>
            <div class="filter-section">
                <input type="text" id="searchFilter" placeholder="Buscar en historial...">
                <select id="sortFilter">
                    <option value="newest">M√°s recientes</option>
                    <option value="oldest">M√°s antiguos</option>
                </select>
            </div>

            <div id="checkinsList" class="checkins-list">
                <!-- Se llenar√° con JavaScript -->
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <p>No hay check-ins todav√≠a</p>
                <a href="checkin.html" class="btn-primary">Hacer primer check-in</a>
            </div>
        </main>
    </div>

    <script src="js/storage.js"></script>
    <script>
        function formatDate(isoString) {
            const date = new Date(isoString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('es-ES', options);
        }

        function renderCheckins(checkins) {
            const listDiv = document.getElementById('checkinsList');
            const emptyState = document.getElementById('emptyState');

            if (checkins.length === 0) {
                listDiv.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            listDiv.style.display = 'block';
            emptyState.style.display = 'none';

            listDiv.innerHTML = checkins.map(checkin => `
                <div class="checkin-item" data-id="${checkin.id}">
                    ${checkin.photo ? `<img src="${checkin.photo}" alt="Foto" class="checkin-photo">` : ''}
                    <div class="checkin-content">
                        <div class="checkin-place">
                            ${checkin.place ? checkin.place.name : 'Ubicaci√≥n GPS'}
                        </div>
                        <div class="checkin-time">${formatDate(checkin.timestamp)}</div>
                        ${checkin.note ? `<div class="checkin-note">${checkin.note}</div>` : ''}
                        <div class="checkin-coords">
                            ${checkin.location.lat.toFixed(6)}, ${checkin.location.lng.toFixed(6)}
                        </div>
                    </div>
                    <div class="checkin-actions">
                        <button class="btn-icon delete-btn" data-id="${checkin.id}">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            // Event listeners para eliminar
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    if (confirm('¬øEliminar este check-in?')) {
                        Storage.deleteCheckin(id);
                        loadCheckins();
                    }
                });
            });
        }

        function loadCheckins() {
            let checkins = Storage.getAllCheckins();
            
            // Filtrar por b√∫squeda
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            if (searchTerm) {
                checkins = checkins.filter(c => {
                    const placeName = c.place?.name?.toLowerCase() || '';
                    const note = c.note?.toLowerCase() || '';
                    return placeName.includes(searchTerm) || note.includes(searchTerm);
                });
            }

            // Ordenar
            const sortOrder = document.getElementById('sortFilter').value;
            checkins.sort((a, b) => {
                return sortOrder === 'newest' 
                    ? new Date(b.timestamp) - new Date(a.timestamp)
                    : new Date(a.timestamp) - new Date(b.timestamp);
            });

            renderCheckins(checkins);
        }

        // Cargar al iniciar
        document.addEventListener('DOMContentLoaded', loadCheckins);

        // Listeners para filtros
        document.getElementById('searchFilter').addEventListener('input', loadCheckins);
        document.getElementById('sortFilter').addEventListener('change', loadCheckins);
    </script>
</body>
</html>
